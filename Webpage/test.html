<html>

<head>
    <style type="text/css">
        #container {
            height: 600px;
            width: 100%;
            margin: 0;
        }
    </style>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="plotly.extensions.js"></script>
    <script src="sigma/sigma.min.js"></script>
    <script src="sigma/plugins/sigma.layout.forceAtlas2.min.js"></script>
</head>

<body>

    <div id="chart"></div>
    <div id="chart3" style="width: 100%;"></div>
    <div id="statistics" style="width: 100%;"></div>
    <div id="convergence-rate" style="width: 100%;"></div>

    <script>
        // const API_BASE_ADDRESS = 'https://acmonitor.azurewebsites.net/api/'
        const API_BASE_ADDRESS = 'http://localhost:7071/api/'


        let div = document.getElementById('chart3');

        setInterval(function x() {
            fetch(API_BASE_ADDRESS + 'analytics/plotly/1/240', {
                method: 'post',
                body: JSON.stringify(div.lastIterations)
            }).then(data => { console.log(data); return data.text(); })
                .then(data => {
                    data = JSON.parse(data);
                    updateTrace('chart3', data.data, data.lastIterations);
                    updateTrace('statistics', data.statistics, null);
                });
            return x;
        }(), 5000);

    </script>



    <div id="container"></div>


    <script>
        // s = sigma.parsers.json('data.json', {
        //     container: 'container',
        //     settings: {
        //         defaultNodeColor: '#ec5148'
        //     }
        // });

        function loadGraph(div) {
            if (typeof div === "string") div = document.getElementById(div);

            setInterval(function x() {
                fetch(API_BASE_ADDRESS + 'analytics/sigma/1/240')
                    .then(data => data.status === 200 ? data.json() : {})
                    .then(data => showGraph(div, data));
                return x;
            }(), 10000)
        }

        loadGraph('container')



        // fetch(API_BASE_ADDRESS + 'analytics/graph/4/240').then(data => data.status === 200 ? data.json() : {}).then(data => showGraph(data))

        function showGraph(div, data) {
            if (typeof div === "string") div = document.getElementById(div);

            console.log(data)
            if (!div || !data.nodes.length) { return; }

            if (!div.sigInstance) {

                div.sigInstance = new sigma({
                    graph: data,
                    container: div,
                    renderer: {
                        container: div,
                        type: 'canvas'
                    },
                    settings: {
                        minNodeSize: 5,
                        maxNodeSize: 20,
                        render: true
                    }
                });

                div.sigInstance.startForceAtlas2({ worker: true, barnesHutOptimize: false });
                setTimeout(() => div.sigInstance.stopForceAtlas2(), 1000)
                return;
            }

            graph = div.sigInstance.graph
            graph.nodes().forEach(element => {
                element.size = Math.random() * 20
            });
            if (div.sigInstance) {
                setTimeout(() => { div.sigInstance.graph.nodes().filter(node => node['id'] === '127.0.0.2').pop().color = 'red'; div.sigInstance.refresh(); }, 3000);
            }
        }

    </script>
</body>

</html>